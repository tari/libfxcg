name: Build Windows SDK package
on: push

jobs:
  build_windows_toolchain:
    name: Build Windows toolchain
    runs-on: ubuntu-latest
    container:
      image: docker://tari/libfxcg-toolchain
    steps:
      - name: Install packages
        run: |
          apt-get -qqy update
          apt-get -qq install build-essential curl mingw-w64 texinfo
      - name: Create GCC directories
        run: mkdir gcc-src gcc-build gcc-bin

      - uses: actions/cache@v1
        id: cache-binaries
        name: Cache toolchain binaries
        with:
          path: gcc-bin
          key: gcc-win-9.3.0
      - uses: actions/cache@v1
        id: cache-sources
        if: steps.cache-binaries.outputs.cache-hit != 'true'
        name: Cache GCC sources
        with:
          path: gcc-src
          key: gcc-src-9.3.0
      - name: Download GCC sources
        if: steps.cache-binaries.outputs.cache-hit != 'true' && steps.cache-sources.outputs.cache-hit != 'true'
        run: |
          cd gcc-src
          curl -L http://ftpmirror.gnu.org/gcc/gcc-9.3.0/gcc-9.3.0.tar.xz | tar xJ
          curl -L http://ftpmirror.gnu.org/mpfr/mpfr-4.0.2.tar.xz | tar xJ
          ln -sr mpfr-4.0.2 ./gcc-9.3.0/mpfr
          curl -L http://ftpmirror.gnu.org/gmp/gmp-6.2.0.tar.xz | tar xJ
          ln -sr gmp-6.2.0 ./gcc-9.3.0/gmp
          curl -L http://ftpmirror.gnu.org/mpc/mpc-1.1.0.tar.gz | tar xz
          ln -sr mpc-1.1.0 ./gcc-9.3.0/mpc

      - name: Build GCC
        if: steps.cache-binaries.outputs.cache-hit != 'true'
        run: |
          cd gcc-build
          ../gcc-src/gcc-9.3.0/configure \
              --target=sh3eb-elf --with-endian=big \
              --with-pkgversion=PrizmSDK \
              --host=i686-w64-mingw32 \
              --prefix=/ \
              --without-headers --enable-languages=c,c++ \
              --disable-tls --disable-nls --disable-threads --disable-shared \
              --disable-libssp --disable-libvtv --disable-libada \
              --disable-gcov --disable-libgomp

          make -j$(nproc) inhibit_libc=true all-gcc
          make DESTDIR=${GITHUB_WORKSPACE}/gcc-bin install-gcc

          make -j$(nproc) inhibit_libc=true all-target-libgcc
          make DESTDIR=${GITHUB_WORKSPACE}/gcc-bin install-target-libgcc

      - uses: actions/upload-artifact@v1
        with:
          name: gcc-mingw-w64-bin
          path: gcc-bin

  build_libfxcg:
    name: Build libfxcg
    runs-on: ubuntu-latest
    container:
      image: tari/libfxcg-toolchain
    steps:
      - uses: actions/checkout@v2
      - name: Compile
        run: |
          make
          mkdir dist
          cp -r lib include dist
      - uses: actions/upload-artifact@v1
        with:
          name: libfxcg
          path: dist
